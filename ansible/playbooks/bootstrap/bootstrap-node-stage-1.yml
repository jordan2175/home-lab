---

# ------------------------------------------------------------
# Step 0: Test connectivity 
# ------------------------------------------------------------
# 1. Make sure root's public key is in the authorized_keys file
# 2. Login to each system with the existing account's username
#    to accept the SSH host key 

# generate_ssh_key: true 
# ssh_key_type: ed25519
# ssh_key_comment: "Generated by ansible on $hostname"


# How to run:
# ansible-playbook playbooks/bootstrap/bootstrap-node-stage-1.yml


- hosts: bootstrap
  become: true
  # vars_prompt:

  #   - name: basic_user
  #     prompt: "Username for basic user: "
  #     private: false

  #   - name: basic_user_full_name
  #     prompt: "Full name for basic user: "
  #     private: false

  #   - name: ansible_username
  #     prompt: "Ansible username: "
  #     private: false

  remote_user: root

  tasks:


# ------------------------------------------------------------
# Users and Groups:
# ------------------------------------------------------------

# Ansible user

  - name: Create an ansible group
    ansible.builtin.group:
      name: ansible
      system: true
      state: present


  - name: Create an ansible user
    ansible.builtin.user:
      name: ansible
      comment: Ansible User
      system: true
      password_lock: true
      append: true 
      group: ansible
      groups: adm,sudo,ansible
      create_home: true
      shell: /bin/bash 
      state: present

  - name: Add ansible's public key to all nodes
    ansible.posix.authorized_key: 
      user: ansible
      # Look up key on the controller and copy it to the node
      key: "{{ lookup('file', '/home/ansible/.ssh/id_ed25519.pub') }}" 
      state: present

  - name: Create a sudoers file for the ansible user
    copy:
      content: ansible ALL = (ALL) NOPASSWD:ALL
      dest: /etc/sudoers.d/ansible
      owner: root
      group: root
      mode: '0440'

# My user

  - name: Create group for my user
    ansible.builtin.group:
      name: jordan
      state: present

  - name: Create my user
    ansible.builtin.user:
      name: jordan
      comment: Bret Jordan
      password_lock: false
      # password: output from <mkpasswd --method=SHA-512 --rounds=500000>
      append: true 
      group: jordan
      groups: adm,sudo,jordan
      create_home: true
      shell: /bin/bash 
      state: present

  - name: Add my user's public key to all nodes
    ansible.posix.authorized_key: 
      user: jordan
      # Look up key on the controller and copy it to the node
      key: "{{ lookup('file', '/home/jordan/.ssh/id_ed25519.pub') }}" 
      state: present

  - name: Create a sudoers file for the my user
    copy:
      content: jordan ALL = (ALL) NOPASSWD:ALL
      dest: /etc/sudoers.d/jordan
      owner: root
      group: root
      mode: '0440'

# ------------------------------------------------------------
